from __future__ import annotations
from math import sqrt
import os
from collections import defaultdict
from typing import Optional

from aqt import mw

from .funcs import get_dark_mode, get_file


def build_svg_mappings(bindings: dict, controller: str) -> dict:
    svg = defaultdict(dict)
    for state in bindings.keys():
        for mod in bindings[state]:
            svg[state][mod] = buildSVG(controller, bindings[state][mod])

    return svg


def get_svg_file(file: str) -> str:
    addon_path = os.path.dirname(os.path.abspath(__file__))
    path = os.path.join(addon_path, 'controllers')
    with open(os.path.join(path, file)) as f:
        return f.read()


def buildSVG(controller: str, mapping: Optional[dict] = None) -> str:
    svg = get_svg_file(controller)
    annotations = list('')
    if mapping:
        for control, action in mapping.items():
            if action:
                annotations.append(generateAnnotation(controller, control, action))
    else:
        for control in CONTROLLER_IMAGE_MAPS[controller]:
            annotations.append(generateAnnotation(controller, control))
    return svg[:-13] + '\n'.join(annotations) + svg[-13:]


def generateAnnotation(controller: str, control: int, text: Optional[str] = None) -> str:
    if control not in CONTROLLER_IMAGE_MAPS[controller]: return ""
    x1, y1, x2, y2, anchor = CONTROLLER_IMAGE_MAPS[controller][control]
    output = f'<line x1="{x1}" y1="{y1}" x2="{x2}" y2="{y2}" />'
    if text:
        output += f"""\n<text text-anchor="{['start','middle','end'][anchor]}" x="{x2}" y="{y2}">{text}</text>"""

    return output


def getAnnotationLines(controller: str, control: int):
    CONTROLLER_IMAGE_MAPS[controller][control]


def build_svg(controller: str, mapping: Optional[dict] = None):
    svg = get_svg_file(controller)
    if mapping:
        controls = [control for control in CONTROL_MAPS[controller] if control in mapping]
    else:
        controls = CONTROL_MAPS[controller]

    boundary = CONTROLLER_BOUNDARIES[controller]

    coords = [(0, boundary[2])]
    a, b =  boundary[1] - boundary[0], boundary[2] - boundary[3]
    d = len(controls)

    for _ in range(len(controls)-1):
        x, y = coords[-1]
        x = x + d / sqrt(1 + b*b*x*x / (a*a(a*a-x*x)))
        y = b * sqrt(1 - x*x/a*x)
        coords.append((x,y))

    if mapping:
        annotations = [generate_annotation(control_x, control_y, an_x, an_y, text) for (control_x, control_y), (an_x, an_y), (key, text) in zip(coords, controls, mapping.items())]
    else:
        annotations = [generate_annotation(control_x, control_y, an_x, an_y) for (control_x, control_y), (an_x, an_y) in zip(controls, coords)]

    return svg[:-13] + '\n'.join(annotations) + svg[-13:]


def generate_annotation(control_x: int, control_y: int, an_x: int, an_y: int, text: str = None) -> str:
    output = f'<line x1="{control_x}" y1="{control_y}" x2="{an_x}" y2="{an_y}" />'
    if text:
        output += f"""\n<text text-anchor="middle" x="{an_x}" y="{an_y}">{text}</text>"""
    return output
    

CONTROLLER_BOUNDARIES = {
    "DualShock 4": (20, 100, 30, 60)
}


CONTROL_MAPS = {
    "DualShock 3": {
        0: (105,50,120,50,0),
        1: (113,43,120,43,0),
        2: (95,46,95,65,2),
        3: (105,36,120,36,0),
        4: (43,23,35,17,2),
        5: (105,23,115,17,0),
        6: (48,22,45,10,0),
        7: (100,22,105,10,0),
        8: (65,41,60,18,1),
        9: (85,41,90,18,1),
        10: (60,56,60,70,0),
        11: (90,56,90,70,2),
        12: (45,35,30,35,2),
        13: (45,50,30,50,2),
        14: (40,43,30,43,2),
        15: (53,45,50,65,0),
        16: (75,48,75,10,1),
        },
    "DualShock 4": {
        0: (106,46,120,46,0),
        1: (112.5,39.5,120,39.5,0),
        2: (97,42,105,90,1),
        3: (106,32.5,120,32.5,0),
        4: (48,25,35,17,2),
        5: (100,25,115,17,0),
        6: (48,25,45,8,0),
        7: (100,25,105,8,0),
        8: (56,28,58,18,1),
        9: (93,28,92,18,1),
        10: (62,53,45,60,0),
        11: (88,53,100,60,2),
        12: (45,34,30,34,2),
        13: (45,46,30,46,2),
        14: (40,40,30,40,2),
        15: (52,42,48,90,2),
        16: (75,55,75,70,1),
        17: (75,30,75,10,1),
    },
    "DualSense": {
        0: (105,45,120,45,0),
        1: (111.5,38,120,38,0),
        2: (96,41,102,52,0),
        3: (106,31,120,31,0),
        4: (48,23,30,17,2),
        5: (100,23,120,17,0),
        6: (48,23,45,10,0),
        7: (100,23,105,10,0),
        8: (56,28,55,18,1),
        9: (95,28,95,18,1),
        10: (57,53,50,60,2),
        11: (94,53,100,60,0),
        12: (45,32,30,33,2),
        13: (45,44,30,45,2),
        14: (40,38,30,39,2),
        15: (53,40,48,53,2),
        16: (75,50,75,65,1),
        17: (75,25,75,10,1),
    },
    "JoyCon": { # needs transform removed
        0: (107,42,120,45,0),
        1: (112,36,120,35,0),
        2: (100,36,81,41,2),
        3: (107,30,120,25,0),
        4: (48,22,35,17,2),
        5: (100,22,115,17,0),
        6: (48,22,45,8,0),
        7: (100,22,105,8,0),
        8: (50,27,68,30,0),
        9: (100,27,82,25,2),
        10: (45,35,30,30,2),
        11: (106,53,111,62,0),
        12: (44,46,30,44,2),
        13: (44,58,30,60,2),
        14: (38,52,30,52,2),
        15: (49.5,53,60,60,0),
        16: (46,63,46,85,1),
        17: (103,63,103,85,1),
    },
    "JoyCon Left": {
        0: (75,45,75,22,1),
        1: (69,51,60,70,2),
        2: (75,56,75,80,1),
        3: (81,51,90,70,0),
        4: (60,34,50,25,2),
        5: (85,34,100,25,0),
        6: (59,52,40,60,0),
        7: (50,44,30,50,0),
        8: (86,48,110,48,0),
    },
    "JoyCon Right": {
        0: (87,45,70,22,0),
        1: (81,51,71,70,2),
        2: (87,56,86,80,1),
        3: (93,51,101,70,0),
        4: (60,35,50,25,2),
        5: (85,35,100,25,0),
        6: (71,52,50,65,0),
        7: (60,49,35,60,0),
        8: (95,46,110,46,0),
    },
    "Switch Pro Controller": {
        0: (100,47,120,47,0),
        1: (107,39,120,39,0),
        2: (91,42,102,55,0),
        3: (100,31,120,31,0),
        4: (48,23,35,17,2),
        5: (100,23,115,17,0),
        6: (48,23,45,10,0),
        7: (100,23,105,10,0),
        8: (64,32,62,18,1),
        9: (86,32,88,18,1),
        10: (45,36,35,26,0),
        11: (90,53,107,70,2),
        12: (60,44,40,49,2),
        13: (60,57,40,63,2),
        14: (54,50.5,40,56,2),
        15: (68,53,55,70,2),
        16: (80,40,70,65,0),
        17: (69,38,75,10,1),
    },
    "Steam Controller": {
        0: (105,65,120,45,0),
        1: (111.5,58,120,38,0),
        2: (96,61,102,52,0),
        3: (106,51,106,31,0),
        4: (48,23,35,17,2),
        5: (100,23,115,17,0),
        6: (48,23,45,10,0),
        7: (100,23,105,10,0),
        8: (75,40,60,18,1),
        9: (75,40,90,18,1),
        10: (65,50,50,75,0),
        11: (110,30,130,50,2),
        12: (50,32,40,33,2),
        13: (55,44,40,45,2),
        14: (50,38,40,39,2),
        15: (63,40,58,53,2),
        16: (75,40,75,65,1),
    },
    "Wii Remote": {
        0: (80,70,100,70,0),
        1: (80,80,100,80,0),
        2: (80,33,100,40,0),
        3: (70,35,60,40,2),
        4: (85,50,100,60,0),
        5: (75,50,40,60,2),
        6: (80,50,75,40,0),
    },
    "Xbox 360 Controller": {
        0: (100,45,120,45,0),
        1: (106,38,120,38,0),
        2: (91,38,95,50,0),
        3: (100,31,120,31,0),
        4: (45,23,35,17,2),
        5: (103,23,115,17,0),
        6: (48,22,45,8,0),
        7: (100,22,105,8,0),
        8: (65,38,61,15,1),
        9: (83,38,89,15,1),
        10: (49,35,30,30,2),
        11: (85,52,85,70,1),
        12: (61,48,40,40,2),
        13: (61,55,40,60,2),
        14: (57,51,40,50,2),
        15: (65,51,65,62,1),
        16: (75,40,75,5,1),
    },
    "Xbox One Controller": {
        0: (99,44,120,44,0),
        1: (105,37,120,37,0),
        2: (90,38,95,50,0),
        3: (99,31,120,31,0),
        4: (49,23,35,17,2),
        5: (99,23,115,17,0),
        6: (49,23,45,8,0),
        7: (99,23,105,8,0),
        8: (68,37,61,15,1),
        9: (81,37,89,15,1),
        10: (55,36,30,30,2),
        11: (86,48,90,60,0),
        12: (61,47,40,40,2),
        13: (61,55,40,60,2),
        14: (57,50,40,50,2),
        15: (68,52,65,70,2),
        16: (75,28,75,5,1),
    },
    "Xbox Series Controller": {
        0: (99,44,120,44,0),
        1: (105,37,120,37,0),
        2: (90,38,95,50,0),
        3: (99,31,120,31,0),
        4: (49,23,35,17,2),
        5: (99,23,115,17,0),
        6: (49,23,45,8,0),
        7: (99,23,105,8,0),
        8: (68,37,61,15,1),
        9: (81,37,89,15,1),
        10: (55,36,30,30,2),
        11: (86,48,90,60,0),
        12: (61,47,40,40,2),
        13: (61,55,40,60,2),
        14: (57,50,40,50,2),
        15: (68,52,65,70,2),
        16: (75,28,75,5,1),
        17: (75,50,75,70,1),
    },
    "Xbox Adaptive Controller": {
        0: (105,50,0,0,0),
        1: (113,43,0,0,0),
        2: (80,30,100,5,0),
        3: (80,35,100,15,0),
        4: (80,40,100,25,0),
        5: (80,35,100,35,0),
        6: (80,50,100,45,0),
        7: (80,55,100,55,0),
        8: (80,60,100,65,0),
        9: (80,65,100,75,0),
        10: (80,70,100,85,0),
        11: (80,75,100,95,0),
        12: (61,47,40,40,2),
        13: (61,55,40,60,2),
        14: (57,50,40,50,2),
        15: (68,52,65,62,2),
        16: (75,48,0,0,0),
        17: (0,0,0,0,0),
    },
    "Super Nintendo Controller": {
        0: (105,60,120,60,0),
        1: (113,53,120,53,0),
        2: (95,56,95,80,0),
        3: (105,46,120,46,0),
        4: (43,33,35,27,2),
        5: (105,33,115,27,0),
        6: (70,55,50,80,2),
        7: (80,55,60,85,2),
    },
}




CONTROLLER_IMAGE_MAPS = {
    "DualShock 3": {
        0: (105,50,120,50,0),
        1: (113,43,120,43,0),
        2: (95,46,95,65,2),
        3: (105,36,120,36,0),
        4: (43,23,35,17,2),
        5: (105,23,115,17,0),
        6: (48,22,45,10,0),
        7: (100,22,105,10,0),
        8: (65,41,60,18,1),
        9: (85,41,90,18,1),
        10: (60,56,60,70,0),
        11: (90,56,90,70,2),
        12: (45,35,30,35,2),
        13: (45,50,30,50,2),
        14: (40,43,30,43,2),
        15: (53,45,50,65,0),
        16: (75,48,75,10,1),
        },
    "DualShock 4": {
        0: (106,46,120,46,0),
        1: (112.5,39.5,120,39.5,0),
        2: (97,42,105,90,1),
        3: (106,32.5,120,32.5,0),
        4: (48,25,35,17,2),
        5: (100,25,115,17,0),
        6: (48,25,45,8,0),
        7: (100,25,105,8,0),
        8: (56,28,58,18,1),
        9: (93,28,92,18,1),
        10: (62,53,45,60,0),
        11: (88,53,100,60,2),
        12: (45,34,30,34,2),
        13: (45,46,30,46,2),
        14: (40,40,30,40,2),
        15: (52,42,48,90,2),
        16: (75,55,75,70,1),
        17: (75,30,75,10,1),
    },
    "DualSense": {
        0: (105,45,120,45,0),
        1: (111.5,38,120,38,0),
        2: (96,41,102,52,0),
        3: (106,31,120,31,0),
        4: (48,23,30,17,2),
        5: (100,23,120,17,0),
        6: (48,23,45,10,0),
        7: (100,23,105,10,0),
        8: (56,28,55,18,1),
        9: (95,28,95,18,1),
        10: (57,53,50,60,2),
        11: (94,53,100,60,0),
        12: (45,32,30,33,2),
        13: (45,44,30,45,2),
        14: (40,38,30,39,2),
        15: (53,40,48,53,2),
        16: (75,50,75,65,1),
        17: (75,25,75,10,1),
    },
    "JoyCon": { # needs transform removed
        0: (107,42,120,45,0),
        1: (112,36,120,35,0),
        2: (100,36,81,41,2),
        3: (107,30,120,25,0),
        4: (48,22,35,17,2),
        5: (100,22,115,17,0),
        6: (48,22,45,8,0),
        7: (100,22,105,8,0),
        8: (50,27,68,30,0),
        9: (100,27,82,25,2),
        10: (45,35,30,30,2),
        11: (106,53,111,62,0),
        12: (44,46,30,44,2),
        13: (44,58,30,60,2),
        14: (38,52,30,52,2),
        15: (49.5,53,60,60,0),
        16: (46,63,46,85,1),
        17: (103,63,103,85,1),
    },
    "JoyCon Left": {
        0: (75,45,75,22,1),
        1: (69,51,60,70,2),
        2: (75,56,75,80,1),
        3: (81,51,90,70,0),
        4: (60,34,50,25,2),
        5: (85,34,100,25,0),
        6: (59,52,40,60,0),
        7: (50,44,30,50,0),
        8: (86,48,110,48,0),
    },
    "JoyCon Right": {
        0: (87,45,70,22,0),
        1: (81,51,71,70,2),
        2: (87,56,86,80,1),
        3: (93,51,101,70,0),
        4: (60,35,50,25,2),
        5: (85,35,100,25,0),
        6: (71,52,50,65,0),
        7: (60,49,35,60,0),
        8: (95,46,110,46,0),
    },
    "Switch Pro Controller": {
        0: (100,47,120,47,0),
        1: (107,39,120,39,0),
        2: (91,42,102,55,0),
        3: (100,31,120,31,0),
        4: (48,23,35,17,2),
        5: (100,23,115,17,0),
        6: (48,23,45,10,0),
        7: (100,23,105,10,0),
        8: (64,32,62,18,1),
        9: (86,32,88,18,1),
        10: (45,36,35,26,0),
        11: (90,53,107,70,2),
        12: (60,44,40,49,2),
        13: (60,57,40,63,2),
        14: (54,50.5,40,56,2),
        15: (68,53,55,70,2),
        16: (80,40,70,65,0),
        17: (69,38,75,10,1),
    },
    "Steam Controller": {
        0: (105,65,120,45,0),
        1: (111.5,58,120,38,0),
        2: (96,61,102,52,0),
        3: (106,51,106,31,0),
        4: (48,23,35,17,2),
        5: (100,23,115,17,0),
        6: (48,23,45,10,0),
        7: (100,23,105,10,0),
        8: (75,40,60,18,1),
        9: (75,40,90,18,1),
        10: (65,50,50,75,0),
        11: (110,30,130,50,2),
        12: (50,32,40,33,2),
        13: (55,44,40,45,2),
        14: (50,38,40,39,2),
        15: (63,40,58,53,2),
        16: (75,40,75,65,1),
    },
    "Wii Remote": {
        0: (80,70,100,70,0),
        1: (80,80,100,80,0),
        2: (80,33,100,40,0),
        3: (70,35,60,40,2),
        4: (85,50,100,60,0),
        5: (75,50,40,60,2),
        6: (80,50,75,40,0),
    },
    "Xbox 360 Controller": {
        0: (100,45,120,45,0),
        1: (106,38,120,38,0),
        2: (91,38,95,50,0),
        3: (100,31,120,31,0),
        4: (45,23,35,17,2),
        5: (103,23,115,17,0),
        6: (48,22,45,8,0),
        7: (100,22,105,8,0),
        8: (65,38,61,15,1),
        9: (83,38,89,15,1),
        10: (49,35,30,30,2),
        11: (85,52,85,70,1),
        12: (61,48,40,40,2),
        13: (61,55,40,60,2),
        14: (57,51,40,50,2),
        15: (65,51,65,62,1),
        16: (75,40,75,5,1),
    },
    "Xbox One Controller": {
        0: (99,44,120,44,0),
        1: (105,37,120,37,0),
        2: (90,38,95,50,0),
        3: (99,31,120,31,0),
        4: (49,23,35,17,2),
        5: (99,23,115,17,0),
        6: (49,23,45,8,0),
        7: (99,23,105,8,0),
        8: (68,37,61,15,1),
        9: (81,37,89,15,1),
        10: (55,36,30,30,2),
        11: (86,48,90,60,0),
        12: (61,47,40,40,2),
        13: (61,55,40,60,2),
        14: (57,50,40,50,2),
        15: (68,52,65,70,2),
        16: (75,28,75,5,1),
    },
    "Xbox Series Controller": {
        0: (99,44,120,44,0),
        1: (105,37,120,37,0),
        2: (90,38,95,50,0),
        3: (99,31,120,31,0),
        4: (49,23,35,17,2),
        5: (99,23,115,17,0),
        6: (49,23,45,8,0),
        7: (99,23,105,8,0),
        8: (68,37,61,15,1),
        9: (81,37,89,15,1),
        10: (55,36,30,30,2),
        11: (86,48,90,60,0),
        12: (61,47,40,40,2),
        13: (61,55,40,60,2),
        14: (57,50,40,50,2),
        15: (68,52,65,70,2),
        16: (75,28,75,5,1),
        17: (75,50,75,70,1),
    },
    "Xbox Adaptive Controller": {
        0: (105,50,0,0,0),
        1: (113,43,0,0,0),
        2: (80,30,100,5,0),
        3: (80,35,100,15,0),
        4: (80,40,100,25,0),
        5: (80,35,100,35,0),
        6: (80,50,100,45,0),
        7: (80,55,100,55,0),
        8: (80,60,100,65,0),
        9: (80,65,100,75,0),
        10: (80,70,100,85,0),
        11: (80,75,100,95,0),
        12: (61,47,40,40,2),
        13: (61,55,40,60,2),
        14: (57,50,40,50,2),
        15: (68,52,65,62,2),
        16: (75,48,0,0,0),
        17: (0,0,0,0,0),
    },
    "Super Nintendo Controller": {
        0: (105,60,120,60,0),
        1: (113,53,120,53,0),
        2: (95,56,95,80,0),
        3: (105,46,120,46,0),
        4: (43,33,35,27,2),
        5: (105,33,115,27,0),
        6: (70,55,50,80,2),
        7: (80,55,60,85,2),
    },
}